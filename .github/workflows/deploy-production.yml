name: Build and Deploy to Cloud Run

on:
  push:
    branches:
      - main

env:
  PROJECT_ID: ${{ secrets.RUN_PROJECT_PRODUCTION}}
  RUN_REGION: us-central1
  PROJECT_NAME: product-builder

jobs:
  setup-build-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      # Setup gcloud CLI
      - name: Setup python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Export gcloud related env variable
        run: export CLOUDSDK_PYTHON="/usr/bin/python3"

      - uses: google-github-actions/setup-gcloud@v2
        with:
          version: '286.0.0'
          service_account_email: ${{ secrets.RUN_SA_EMAIL_PRODUCTION}}
          service_account_key: ${{ secrets.RUN_SA_KEY_PRODUCTION}}
          project_id: ${{ secrets.RUN_PROJECT_PRODUCTION}}

      # Build and push image to Google Container Registry
      - name: Build
        run: |-
          gcloud builds submit \
            --timeout "1h" \
            --tag "gcr.io/$PROJECT_ID/$PROJECT_NAME-${GITHUB_REF##*/}:$GITHUB_SHA" 

      # Deploy image to Cloud Run for API
      - name: Deploy API
        run: |-
          gcloud run deploy "$PROJECT_NAME-${GITHUB_REF##*/}" \
            --region "$RUN_REGION" \
            --quiet \
            --image "gcr.io/$PROJECT_ID/$PROJECT_NAME-${GITHUB_REF##*/}:$GITHUB_SHA" \
            --platform "managed" \
            --memory "8192Mi" \
            --cpu 2 \
            --timeout 30m30s \
            --allow-unauthenticated \
            --set-env-vars "ENVIRONMENT=PRODUCTION" \
            --set-env-vars "OPENAI_API_KEY=$OPENAI_API_KEY" \
            --set-env-vars "AWS_S3_ACCESS_KEY=$AWS_S3_ACCESS_KEY" \
            --set-env-vars "AWS_S3_ACCESS_SECRET=$AWS_S3_ACCESS_SECRET" \
